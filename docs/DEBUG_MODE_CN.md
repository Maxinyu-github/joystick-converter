# Debug模式使用指南

## 概述

Debug模式（调试模式）允许你从配置软件中实时查看手柄输入数据。这对以下场景特别有用：
- 识别你的手柄支持哪些按键
- 检测特殊按键（摇杆按键、背键、额外按键等）
- 排查按键映射问题
- 了解不同手柄型号的原始数据

## 功能特性

Debug模式显示：
- **按键状态**：所有标准按键的可视化指示器（A、B、X、Y、LB、RB、Back、Start、LS、RS）
- **摇杆**：左右摇杆的实时X/Y位置值
- **扳机**：左右扳机的压力值（0-255）
- **方向键**：当前方向指示器
- **原始按键数据**：十六进制按键位图，用于识别未映射的按键

## 如何使用Debug模式

### 1. 连接设备

1. 打开配置工具：
   ```bash
   cd config_software
   python config_tool.py
   ```

2. 从下拉列表中选择设备的串口
3. 点击"Connect"（连接）

### 2. 启动Debug模式

1. 点击"Debug Mode"标签页
2. 将手柄连接到转换器设备
3. 点击"Start Debug Mode"（开始调试模式）
4. 状态应该变为"Active"（激活）

### 3. 测试你的手柄

- 按下手柄上的按键，观察它们以绿色高亮显示
- 移动摇杆，查看数值变化
- 拉动扳机，观察进度条
- 使用方向键，查看方向指示器

### 4. 识别特殊按键

**原始按键数据（十六进制）**显示完整的按键位图。每一位代表一个按键：

| 位 | 掩码   | 按键 |
|----|--------|------|
| 0  | 0x0001 | A    |
| 1  | 0x0002 | B    |
| 2  | 0x0004 | X    |
| 3  | 0x0008 | Y    |
| 4  | 0x0010 | LB   |
| 5  | 0x0020 | RB   |
| 6  | 0x0040 | Back |
| 7  | 0x0080 | Start|
| 8  | 0x0100 | LS   |
| 9  | 0x0200 | RS   |
| 10+| 0x0400+| 特殊/额外按键 |

如果你在按下某个按键时看到十六进制值发生变化，但该按键没有在标准按键列表中显示，那么你就找到了一个特殊按键！记下十六进制值和位位置，以便添加对它的支持。

### 5. 停止Debug模式

完成后点击"Stop Debug Mode"（停止调试模式）。设备将返回正常操作模式。

## 理解数据

### 摇杆值
- 范围：-32768 到 32767
- 中心位置：0
- 负值：左（X轴）或下（Y轴）
- 正值：右（X轴）或上（Y轴）

### 扳机值
- 范围：0 到 255
- 0：未按下
- 255：完全按下

### 方向键值
- dpad_x：-1（左）、0（中心）、1（右）
- dpad_y：-1（上）、0（中心）、1（下）

## 故障排除

### "未连接到设备"错误
- 确保你已在连接区域点击了"Connect"
- 验证选择了正确的串口
- 检查设备已开机并插入

### 没有显示数据
- 确保手柄已连接到转换器设备
- 某些手柄可能需要按下按键来激活
- 检查串口连接是否稳定

### 数值看起来不正确
- 某些手柄有不同的中心校准
- 摇杆可能不会完全居中在0
- 这是正常的，固件会处理小的死区

### Debug模式无法启动
- 确保设备固件支持Debug模式
- 检查你使用的是最新的固件版本
- 验证串口通信正常工作（检查连接状态）

## 技术细节

### 通信协议

Debug模式使用简单的基于文本的串口协议（波特率115200）：

**命令**（PC → 设备）：
```
DEBUG_START\n    - 启用调试模式
DEBUG_STOP\n     - 禁用调试模式
DEBUG_GET\n      - 请求当前手柄状态
```

**响应**（设备 → PC）：
```
DEBUG_MODE_STARTED\n                              - 确认
DEBUG_MODE_STOPPED\n                              - 确认
DEBUG:buttons,lx,ly,rx,ry,lt,rt,dx,dy\n          - 状态数据
```

**状态数据格式**：
- `buttons`：16位按键位图（无符号整数）
- `lx`、`ly`：左摇杆X/Y（-32768到32767）
- `rx`、`ry`：右摇杆X/Y（-32768到32767）
- `lt`、`rt`：左右扳机（0-255）
- `dx`、`dy`：方向键X/Y（-1、0、1）

### 轮询速率

当Debug模式激活时，配置工具每50毫秒（20Hz）轮询一次手柄状态。这提供了流畅的视觉反馈，同时不会压垮串口连接。

## 为特殊按键添加支持

使用Debug模式识别特殊按键后：

1. 记录原始数据中特殊按键的位位置
2. 更新`firmware/usb_host.h`以添加新的按键定义：
   ```c
   #define GAMEPAD_BUTTON_SPECIAL  (1 << 10)  // 第10位
   ```
3. 更新配置工具以显示新按键
4. 重新编译并刷新固件

## 使用示例

### 场景1：带背键的Xbox手柄
某些Xbox Elite手柄有背键。在Debug模式下，你可能看到：
- 标准按键正常工作
- 按下背键显示十六进制值变化（例如0x0400）
- 这表示第10位是背键
- 在固件中为此按键添加映射

### 场景2：带触摸板点击的PlayStation手柄
PS4/PS5的触摸板可以点击：
- 标准按键正常工作
- 点击触摸板显示十六进制变化（例如0x0800）
- 这表示第11位是触摸板按键
- 添加支持和映射

### 场景3：带额外按键的通用手柄
廉价手柄可能有turbo或模式按键：
- 这些显示为位图中的额外位
- 使用Debug模式识别每个按键使用哪一位
- 根据需要添加定义和映射

## 相关资料

- [API文档](API.md) - 编程接口详情（英文）
- [示例](EXAMPLES.md) - 按键映射示例（英文）
- [故障排除](TROUBLESHOOTING.md) - 常见问题（英文）
